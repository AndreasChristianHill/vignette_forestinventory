% !Rnw root = JStatSoft_forestinventory_master.Rnw

%\section{Methods and Structure of the Package}
\section{Methods and Structure of the Package}
\label{sec:str_and_mod}


\subsection{Forest Inventory in the Infinite Population Approach}

Most forest inventories gather the field information by randomly or systematically selecting points in the forest area defined by coordinates to which inventorists are sent. At these points, the inventorist measures sample trees located within a constructed circle (called sample plot) around the sample point $x$, and aggregates their individual characteristics (e.g. their individual timber volumes) to local plot densities (e.g. the timber density in $m^3/ha$). The estimators implemented in the \pkg{forestinventory} package use the so called \textit{infinite population approach} in order to bridge this inventory process to the mathematics behind the estimators. The infinite population approach assumes that the spatial distribution of the local density, $Y(x)$, over the forest area is determined by a piecewise constant function, as visualized in Figure \ref{fig:inf_pop_apr}. The \textit{population total} of the target variable (e.g. the total timber volume of the forest) is mathematically equivalent to the integral of that density function, which is depicted in Figure \ref{fig:inf_pop_apr} as the volume under the density surface. From this perspective, the challenging part of an inventory is that the form of this function is unknown. Theoretically, we still could get the total timber volume by observing the function value, i.e. the local density $Y(x)$, at each possible point $x$ over the forest area and sum those obervations up. However, this is impossible because there is an infinite number of points in the forest area. Our strategy is thus to take a sample of points, $s_2$, from an infinite population of possible points and use their associated local densities, i.e. $Y(x)$, to \textit{estimate} the integral $Y=\frac{1}{\lambda(F)}\int_{F}Y(x)dx$ with $\hat{Y}=\frac{1}{n_2}\sum_{s_2}Y(x)$.  The total timber volume can then be obtained by multiplying $\hat{Y}$ by the surface area of the forest, $\lambda(F)$.  All estimators included in the \pkg{forestinventory} package basically rest upon this theoretical approach. A key point for practical implementation is that in the infinite population approach, a local density value $Y(x)$ is associated with the sample point $x$, which constitutes the sample unit, and not to the sample plot area. This has some obvious theoretical advantages over the finite population approach, where the sample units actually are cirular or rectangular plots. One is the impossibility of a perfect tesselation over an amorphous forest area by any kind of plot-shape, and hence, the population in the finite approach is, strictly speaking, not perfectly defined with respect to the forest area. The consideration of an underlying infinite population of sample points will also play an important role when incorporating auxiliary information in the frame of two- and three-phase estimation methods.

\begin{figure}[htb]
\centering
\resizebox{0.42\hsize}{!}{\includegraphics{fig/localdensity_final-01.eps}}
\caption{Artificial representation of a local density surface. The spatial distribution of a hypothetical density function for every point in a forested area is represented as a wavy piecewise constant green surface.  Sample plots (white dots) inform the inventorist of the value of the density function at that point.}
\label{fig:inf_pop_apr}
\end{figure}


% "we are sampling values of a function that is defined by the spatial arrangement of the trees"

% NOTES:
% - Use onephase sampling to explain the difference between finite and infinite population approach
% - infinite population approach: 
%   - Lets assume that the spatial distribution of the target variable (e.g. the timber volume) over the forest area is determined by a fixed mathematical continuous function,
%     and the total amount of the target variable (e.g. the total timber volume of the forest), lets call it $Y$, is the integral of that function, 
%     in other words: the volume that expands under the surface of that function (picture). The thing is that in the inventory context,
%     the form of this function is unknown. Theoretically, we still could get Y by observing the
%     function value Y(x), called the local density, at each possible location $x$ over the function "plane" and sum those obervations up. However, we see at the first spot 
%     that this is impossible, because
%     the number of function values $Y(x)$ and thus the number of possible sample locations $x$ is $infinite$. So the only thing we can do is to get ourself a sample of Y(x)s to 
%     $estimate$ $Y$ by $\hat{Y}$. Since we thereby sample from an infinite population of possible sample locations / function values, this approach is consequently called the 
%     \textit{infinite population approach}.
%   - Transferring this approach to forest inventory problems is indeed straightforward when we reconsider our task of estimating e.g. the true timber volume of the forest 
%     as "estimating the integral of an unknown function that determines the timber volume distribution over our forest". What we do in practice is to visit each sample 
%     location $x$ in the field and determine the respective timber volume value, i.e. local density, by measuring sample trees around each location. 
%     The selection of sample trees is mostly done constructing one or multiple nested circles (sample plots) around a sample location, and include each tree that lies 
%     within the plot boundaries. The local density value is then determined by aggregating the sample tree characteristics (e.g. their indiv. timber volume).
%     Doing so, we get a sample of the infinite number of (sample locations and thus) timber volume values we could theoretically observe in our forest. 
%  -  A key point to understand is that in the infinite population approach, a local density value Y(x) has no spatial association. Even if we used a spatial unit, i.e. 
%    the plot, extended around the sample point to calculate Y(x), its value only corresponds to the sample point / plot center. The best example of non-existing 
%    spatial association of Y(x) is indeed angle count sampling (ref). Whereas the lack of spatial association seems rather distracting in the first place, it actually 
%    has some obvious practical advantages over the finite population approach where the sample units are indeed cirular or rectangular plots.
%


\subsection{Two-Phase Sampling}


The two-phase or double-sampling estimators use inventory information from \textbf{two} nested samples which are commonly referred to as \textit{phases} (Figure \ref{fig:concmphase_and_sae_a}). The first phase $s_1$ comprises $n_1$ sample locations that each provide a set of explanatory variables described by the column vector $\pmb{Z}(x)\in{\Re^{p}}$ at each point $x \in s_1$. These explanatory variables are derived from auxiliary information that is available in high quantity within the forest area $F$. The second phase $s_2$ constitutes the terrestrial inventory conducted at $n_2$ subsamples of the large phase $s_1$ and provides the value of the target variable, i.e. the local density $Y(x)$ (e.g. the timber volume per hectare). The set of explanatory variables at each sample location $x \in s_1$ is transformed into a prediction $\hat{Y}(x)$ of $Y(x)$ using a linear regression model with ordinary least square (OLS) technique. The basic idea of this setup is to boost the sample size by providing a large sample of less precise but cheaper predictions of $Y(x)$ in $x \in s_1$ and to correct any possible model biases, i.e. $\EX{(Y(x)-\hat{Y}(x))}$, using the subsample of terrestrial inventory units where the value of $Y(x)$ is observed. In the design-based context, the two-phase estimator is unbiased regardless of the model used to produce the predictions.  This property comes from the assumption that each phase's sample is selected via simple random sampling (see section \ref{sec:db_vs_md}).
%In the \proglang{R} package \pkg{forestinventory}, estimators for two-phase sampling can be applied with the \code{twophase()} function.



\subsection{Three-Phase Sampling}


The three-phase or triple-sampling estimators extend the principle of two-phase sampling and use inventory information from \textbf{three} nested samples (\textit{phases}) (Figure \ref{fig:concmphase_and_sae_a}). The basic assumption is that auxiliary information is available in two different frequencies, i.e. sample sizes. The phase $s_0$ provides a large number $n_0$ of auxiliary information, whereas the phase $s_1$ provides additional auxiliary information that is only available at $n_1$ subsamples of $s_0$. The terrestrial information is then collected at a subsample $s_2$ of $s_1$ and $s_0$. The basic idea of three-phase sampling is that the additional set of auxiliary information $\pmb{Z}^{(1)}(x)\in{\Re^q}$ adds considerable explanatory power to the set of auxiliary information $\pmb{Z}^{(0)}(x)\in{\Re^p}$ available at all sample locations $x \in s_0$. From that it follows that we can define \textit{two nested} regression models. The \textit{full} set of predictor variables $\pmb{Z}^t(x)=(\pmb{Z}^{(0)t}(x),\pmb{Z}^{(1)t}(x))\in{\Re^{p+q}}$ in the sample $s_1$ can be used to calculate predictions $\hat{Y}_{1}(x)$ of $Y(x)$ at all sample locations $x \in s_1$. The regression model applicable to the $s_1$ phase is thus referred to as the \textit{full model}. Whereas we can only use the subset of auxiliary information $\pmb{Z}^{(0)}(x)$ in the so called \textit{reduced model} at the sample locations $x \in s_0$, it allows for creating a much larger sample of less accurate predictions $\hat{Y}_{0}(x)$. If there is a significant gain in model precision between the reduced and the full model and the sampling fraction between $s_0$ and $s_1$ is sufficiently large, the three-phase estimator normally leads to a further increase in estimation precision compared to the two-phase estimator. 
%In the \proglang{R} package \pkg{forestinventory}, estimators for three-phase sampling can be applied with the \code{threephase()} function.

\begin{figure}[htb]
	\begin{subfigure}[t]{0.5\textwidth}
		\centering
    %\resizebox{1.12\hsize}{!}{\includegraphics{fig/phases_graphic(3).eps}}%
    \resizebox{1\hsize}{!}{\includegraphics{fig/phases_graphic(new).eps}}%
		\caption{} \label{fig:concmphase_and_sae_a}
		\end{subfigure}
	\begin{subfigure}[t]{0.5\textwidth}
		\centering
   %\resizebox{0.8\hsize}{!}{\includegraphics{fig/sae_graphic(3).eps}}%
   \resizebox{0.6\hsize}{!}{\includegraphics{fig/sae_graphic(new).eps}}%
		\caption{} \label{fig:concmphase_and_sae_b}
	\end{subfigure}
\caption{\textbf{(a)} Concept of multiphase sampling. The square represents the forest area for which an inventory is being conducted. The points denote the sample locations $x$. Filled points indicate \textit{available} information. \textbf{(b)} Illustration of the Small Area Estimation problem}
\label{fig:concmphase_and_sae}
\end{figure}

\subsection{Small Area Estimation}


Small area estimation does not necessarily refer to small spatial areas but rather areas that contain little or no terrestrial sample.  In the design-based approach, if there are no terrestrial plots in the small area then there is nothing you can do and you will be forced to depend on the model you choose and accept its potential bias.  To formulate this mathematically, we want to make an estimation for a subregion $G$ of the entire inventory area $F$ (Figure \ref{fig:concmphase_and_sae_b}). If the spatial extent of the subregion is small with respect to the terrestrial sample density, the number of terrestrial sample locations within the subregion $n_{2,G}$ will be too small to provide sufficient estimation precision (i.e. the confidence intervals will be very large). In this case, the application of multiphase estimation procedures can be efficient. However, the terrestrial sample size is too small to justify fitting a separate regression model just that area. The idea is then to \textit{borrow strength} from the entire terrestrial sample $s_2$ of $F$ and then to apply this  model to the small area. The potential bias of applying that model in $G$ is then corrected for by using the model residuals derived from the small area $G$. If no terrestrial samples fall into a small area $G$ (i.e. $n_{2,G}=0$), this bias correction cannot be applied and the resulting \textit{synthetic} estimates are potentially biased. 
% Both two and three-phase small area estimators for synthetic and non-synthetic estimation can be applied by the \code{twophase()} and \code{threephase()} functions in the \proglang{R} package \pkg{forestinventory}.


% NOTES:
% - borrowing strength
% - both, two-and three-phase can be extended to sae estimators
% - explain difference between synthetic and non-sysnthetic estimators
% - soundly derive reasoning, starting with onephase, then twophase


% \begin{figure}[htb]
% 	\begin{subfigure}[t]{0.5\textwidth}
% 		\centering
%     \resizebox{1.12\hsize}{!}{\includegraphics{fig/phases_graphic(3).eps}}%
% 		\caption{} \label{fig:concmphase_and_sae_a}
% 		\end{subfigure}
% 	\begin{subfigure}[t]{0.5\textwidth}
% 		\centering
%    \resizebox{0.8\hsize}{!}{\includegraphics{fig/sae_graphic(3).eps}}%
% 		\caption{} \label{fig:concmphase_and_sae_b}
% 	\end{subfigure}
% \caption{\textbf{(a)} Concept of multiphase sampling. The square represents the forest area for which an inventory is being conducted. The points denote the sample locations $x$. Filled points indicate \textit{available} information. \textbf{(b)} Illustration of the Small Area Estimation problem}
% \label{fig:concmphase_and_sae}
% \end{figure}


\subsection{Design-Based vs. Model-Dependent Approach}
\label{sec:db_vs_md}

The selection of a suitable prediction model is an essential part in the application of multiphase inventories. However, the requirements on the model differ fundamentally between two major mathematical approaches: In the \textit{model-dependent} (also known as \textit{model-based}) framework, the sample locations \textit{x} are fixed and the observation $Y(x)$ taken at location $x$ is assumed to be a random variable as the forest is assumed to be the realization of a stochastic process. One consequence is that the model does not need to be fit from a probability sample, i.e. the sample locations could arbitrarily be chosen. However, another consequence is that for unbiased estimates it has to be insured that the model adequately describes the underlying stochastic process, in other words: the model assumptions have to be met and empirically verified. For example, if we use an ordinary least square regression model, implicit mathematical assumptions are (i) normality and homogeneity of the  target variable \textit{Y}(\textit{x}) at each value of the explanatory variables, and (ii) independence of the target variable \textit{Y}(\textit{x}) or the model residuals $R(x)$, i.e. \textit{Y}(\textit{x}) and $R(x)$ are assumed to be identically distributed, independent random variables and not to be correlated in any way. Whereas verifying the validity of model assumptions can be seen as evidence that the model adequately describes the underlying stochastic process, a proof remains infeasible. This leads to the situation that in the model-dependent framework, one has to \textit{trust} the model. In contrast to the model-dependent approach, the \textit{design-based} approach rests upon the randomization of the sample locations $x$. While the sample locations $x$ are independently and uniformly distributed in the forest, the forest itself and thus the observation $Y(x)$ at any location $x$ is fixed and \textit{not} the result of a stochastic process. Conclusively, the observation \textit{Y}(\textit{x}) still remains a random variable, but solemnly due to the random sample mechanism. A consequence of this approach is that the models used in the design-based regression estimators do no longer have to satisfy any model assumptions in the classical statistical sense (e.g. identical distribution and independence of the observation $Y(x)$, or stationarity assumption in the geostatistical frame), as it is the case in the model-dependent framework \citep{mandallaz2008}. The philosophy of the design-based approach is thus to use prediction models to \textit{improve} the efficiency of the estimators without having to \textit{rely} on their correct specification, which makes them very attractive to be used in official statistics. They are therefore also referred to as \textit{model-assisted}. It should be noted that the random distribution of the sample locations, which the design-based inference rests upon, is in practice often replaced by the use of systematic grids due to minimization of travelling cost in the terrestrial survey. However, there is reasonable and empirical evidence that softening this assumption is acceptable for point estimation as well as the variance estimation as long as the grid does not interact with periodic features in the forest structure (\cite{mandallaz2008} Chapter 7). However, the variance will in most cases be slightly overestimated and thus lead to wider and thus more conservative confidence intervals \citep{mandallaz2013a}.

% Note that while the auxiliary information is most often provided by remote sensing data, that does not necessarily have to be the case. The auxiliary information can be any information that exhibits a correlation to the local density, i.e. target variable, $Y(x)$.
%
% e.g. past inventory data \citep{massey2014a}


\subsection{Package Structure}
\label{sec:packstruc}


% In the \proglang{R} package \pkg{forestinventory}, estimators for two-phase and three-phase sampling can be applied with the \code{twophase()} and \code{threephase()} function. From these two overall function calls, various estimators for specific inventory scenarios under the chosen sampling design can be applied (Figure \ref{fig:struct_package}). The decision what estimator to use thereby follows a tree-like structure which can serve the user as a guideline. The first decision to make is whether an estimate and its variance should be computed for the entire inventory area (\textit{global estimators}) or only for subregions of the entire inventory area (\textit{small area estimators}). The next decision for both global and small area estimations is whether the explanatory variables were derived \textit{exhaustively} or \textit{non-exhaustively} over the inventory area. The first case allows for computing the exact mean $\bar{\pmb{Z}}$ of each explanatory variable over $s_1$ ($s_{1,G}$) and $s_0$ ($s_{0,G}$). In the second case, the mean of each explanatory variable over $s_1$ ($s_{1,G}$) and $s_0$ ($s_{0,G}$) can only be estimated by $\hat{\bar{\pmb{Z}}}$ which adds another component of uncertainty to the respective estimators. The package offers three small area estimators for both the exhaustive and non-exhaustive setup. The \textit{extended synthetic estimator} and the \textit{small area estimator} both apply a bias correction using the model residuals within small area $G$ and can only be applied if the terrestrial sample size $n_{2,G}$ within $G$ is $\geq 2$. The resulting point estimates and variances are asymptotically design-unbiased. If $n_{2,G}=0$, the bias correction can no longer be applied and the estimates of the repsective \textit{synthetic small area estimator} are potentially biased. The package also allows for calculating estimates solely based on the terrestrial sample $s_2$ (\textit{one-phase estimation}) by the \code{onephase()} function. All estimators are also available for \textit{cluster} sampling, in which case a sample unit consists of multiple, spatially agglomerated samples. The following sections describe the mathematical details and the application of the multi-phase estimators implemented in the \proglang{R} package \pkg{forestinventory}. While \cite{mandallaz2008, mandallaz2013techa, mandallaz2013techb,mandallaz2015tech} provides an extensive derivation of all estimators, we will provide the mathematical formulas that are actually implemented in the package. We will also restrict to simple sampling and provide the equations for cluster sampling in the Appendix. A special case under cluster sampling is described in section \ref{sec:speccas_and_scen}.


In the \proglang{R} package \pkg{forestinventory}, estimators for two-phase and three-phase sampling can be applied with the \code{twophase()} and \code{threephase()} function. From these two overall function calls, various estimators for specific inventory scenarios under the chosen sampling design can be applied (Figure \ref{fig:struct_package}). The decision what estimator to use thereby follows a tree-like structure which can serve the user as a guideline throughout this article as well as in future applications. The basic decision to make is whether an estimate and its variance should be computed for an entire inventory area (\textit{global estimators}) or only for subregions of the entire inventory area (\textit{small area estimators}). In the second case, the package offers three small area estimators that will in detail be described in the following sections. The estimators are available under \textit{exhaustive} and \textit{non-exhaustive} use of the auxiliary data. Additionally, the package provides the option of calculating one-phase estimates solely based on terrestrial samples. All estimators are also available for \textit{cluster} sampling, in which case a sample unit consists of multiple, spatially agglomerated samples. The following sections describe the mathematical details and the application of the multi-phase estimators implemented in the \proglang{R} package \pkg{forestinventory}. While \cite{mandallaz2008, mandallaz2013techa, mandallaz2013techb,mandallaz2015tech} provides an extensive derivation of all estimators, we will provide the mathematical formulas that are actually implemented in the package. We will also restrict to simple sampling and provide the equations for cluster sampling in the Appendix. A special case under cluster sampling is described in section \ref{sec:speccas_and_scen}.


\begin{figure}[htb]
\centering
\resizebox{0.95\hsize}{!}{\includegraphics{fig/Package_structure_3.eps}}
\caption{Structure of the multi-phase estimators in the \proglang{R} package \pkg{forestinventory}}
\label{fig:struct_package}
\end{figure}

\newpage
